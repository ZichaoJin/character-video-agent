# 关键帧生成：影响因素 & 画风为什么离谱

## 一、所有影响关键帧生成的因素（按作用顺序）

### 1. 角色参考图（影响最大）

- **位置**：`dataset/你的项目/character_list/布布/`、`一二/` 等。
- **会用到的文件**：`best.png`、`front.png`、`oblique.png`、`side.png`、`back.png`（及 `.jpg`），按优先级取**第一张存在的**。
- **怎么用**：每镜只传**一张**参考图（本镜第一个出现角色的单张图），作为 **Replicate Ideogram Character** 的 `character_reference_image`。Ideogram 官方要求单张、清晰面部，多张拼图会导致人物/画风错乱，故已禁用四方向拼图。
- **影响**：参考图长什么样，模型会尽量往那个方向靠；**参考图本身画风不对，成片一定不对**。必须放「你想要的成片风格」的图（圆润、厚描边、点状眼、腮红、扁平可爱；不要写动物名，严格按参考图）。

### 2. 画风描述 scene_style_text（每镜 prompt 前半段）

- **来源**（二选一）：
  - **A**：`dataset/你的项目/style_reference/` 里放画风参考图 → 用 **GPT-4V** 生成一段「场景与事物的画风」描述 → 写入 `dataset/你的项目/scene_style.txt`；
  - **B**：你直接编辑 `dataset/你的项目/scene_style.txt`。
- **怎么用**：Replicate 每镜的 prompt = **固定英文风格句** + **scene_style_text** + 镜头描述（Plot/Visual Description）。
- **影响**：没有 `style_reference/` 且没写 `scene_style.txt` 时，这段为空，只靠下面的「固定风格句」和镜头描述，画风容易飘。

### 3. 代码里写死的「固定风格句」style_rule

- **位置**：`movie_agent/models/Replicate_Consistent/replicate_consistent.py` 里 `predict()`。
- **内容**（英文）：严格按参考图复制，不写角色类型/动物名；厚描边、圆润体型、扁平插画、不要写实/3D（具体以当前代码为准，且已禁止出现 panda/bear 等动物名）。
- **影响**：每镜 prompt 最前面都会加风格约束，用来约束「厚描边、圆润、扁平、不要写实/3D」。若模型不听话，画风仍可能跑偏。

### 4. 每镜的镜头描述（Plot/Visual Description 或 Coarse Plot）

- **来源**：剧本分镜阶段 **LLM（ShotPlotCreate）** 生成的 `Plot/Visual Description` 或 `Coarse Plot`，来自 `Step_3_shot_results.json` 里每个 shot 的字段。
- **怎么用**：上面 2 和 3 之后，再接 `"\n\n" + 镜头描述`，一起送给 Replicate。
- **影响**：若镜头描述里出现「写实、3D、电影感、真实光影、细腻皮肤」等词，会**和你要的扁平可爱风打架**，容易把画风拉偏。

### 5. Replicate 模型本身（Ideogram Character）

- **模型**：`ideogram-ai/ideogram-character`。
- **特点**：以「单张参考图 + 文本」生成图，**不是**专门「严格复刻画风」的模型；会综合参考图与 prompt，有时更偏向自己训练分布。
- **影响**：即使参考图 + prompt 都对了，模型仍可能一定程度偏离参考图风格（尤其是写实/3D 倾向强的描述）。

### 6. 剧本与分镜的 system prompt

- **位置**：`movie_agent/system_prompts.py`，如 ShotPlotCreate、ScenePlanning 等。
- **内容**：里面对「布布一二」有「cartoon/cute style」等要求，但 LLM 可能仍生成偏写实、偏复杂的镜头描述。
- **影响**：分镜描述若与目标画风不一致，会通过「4」传到关键帧，间接导致画风离谱。

---

## 二、为什么画风会「这么离谱」——常见原因

1. **参考图不对**  
   放在 `character_list/布布/`、`一二/` 里的图不是你要的「圆润、厚描边、点状眼、腮红、扁平」风格，而是别的风格（甚至写实照片）。模型会学参考图，参考图错了，成片一定错。**不要在 prompt 或画风描述里写动物名（如熊猫、熊），否则会暗示模型画成该动物。**

2. **没有画风描述或很弱**  
   没有 `style_reference/`、也没有 `scene_style.txt`，或 `scene_style.txt` 内容很空/很泛。这样只靠一句固定英文 style_rule，约束力有限，模型容易自由发挥。

3. **镜头描述和画风冲突**  
   分镜里的 `Plot/Visual Description` 带有「真实、电影、立体、细腻」等词，或场景描述太长，把前面的风格说明「冲淡」了，模型更按镜头内容画成写实/3D。

4. **Ideogram 模型特性**  
   该模型不是「完全复刻参考图」的模型，参考图 + 文本一起理解，有时会更偏向自己的默认风格，导致和参考图不完全一致。

5. **scene_style 是中文**  
   GPT-4V 生成的 `scene_style.txt` 多为中文，而 Ideogram 主要吃英文 prompt；中文描述可能权重或理解不如英文，风格约束效果打折扣。

---

## 三、建议排查与改进（按优先级）

1. **先确认参考图**  
   - 看终端里打印的 `[Replicate] 本镜参考图: xxx`，确认送进去的是哪张（或四方向拼图）。  
   - 确保 `character_list/布布/`、`一二/` 里放的就是「你要的成片风格」的图（圆润、厚描边、点状眼、腮红、扁平）。不要在任何 prompt 或 scene_style.txt 里写动物名（如熊猫、熊）。

2. **补强画风描述**  
   - 在 `dataset/你的项目/style_reference/` 放 1～3 张**目标画风**的图，重新跑一遍（会生成/更新 `scene_style.txt`）；或  
   - 直接编辑 `scene_style.txt`，写一段简洁的「2D 扁平、圆润线条、点状眼、腮红、不要写实不要 3D」等描述（若能写成英文更好）。

3. **弱化镜头描述里和画风冲突的词**  
   - 审阅 `审阅/剧本_script_synopsis.json` 或 Step_3 的 shot 里的 `Plot/Visual Description`，若发现「realistic / cinematic / 3D / 真实 / 电影感」等，可手动改短、改柔和，或后续在 system prompt 里强调「所有镜头描述必须保持扁平卡通、不要出现写实/3D 用语」。

4. **可选：把 scene_style 翻成英文再注入**  
   - 若 `scene_style.txt` 是中文，可在注入 Replicate 前用 LLM 或简单规则转成英文，再拼到 prompt 里，可能提高 Ideogram 对画风的服从度。

5. **接受模型上限**  
   - 若以上都做了仍不理想，说明 Ideogram Character 在该项目上风格可控性有限，可考虑换用更「吃参考图风格」的模型或本地管线（若有）。

---

## 四、数据流小结（Replicate 关键帧）

```
character_list/布布|一二/  (参考图)
        ↓
  选图/四方向拼图 → character_reference_image
        ↓
scene_style.txt / style_reference → scene_style_text
        ↓
style_rule (代码固定) + scene_style_text + "\n\n" + Plot/Visual Description
        ↓
Replicate Ideogram Character (character_reference_image + prompt)
        ↓
关键帧图片
```

以上即**所有影响关键帧生成的因素**，以及**画风容易离谱的原因和对应改进方向**。优先检查参考图和画风描述，再收紧镜头描述用语。
